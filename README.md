# Siamese Networkを用いた顔認識モデルの構築

## はじめに
顔認識システムを構築する際に、「1対1」モードと「1対多」モードという2つの主要な手法があります。本記事では、特に「1対1」モードに焦点を当て、Siamese Network（サイアムネットワーク）を用いた顔認識モデルの設計と構築について詳しく解説します。

![](assets/eye-catch.png)

## 【1対1モード】と【1対多モード】の違い

顔認識システムには、大きく分けて2つのモードがあります。それぞれの特徴と使用シーンを見てみましょう。

### 【1対1モード】
「1対1」モードは、2つの顔画像を比較し、それらが同一人物かどうかを判定する手法です。このモードは、例えば生体認証やセキュリティ認証など、ペア単位の顔認識が求められるタスクに適しています。

特徴:
- 類似度計算が中心。
- ペア単位での高精度な判定が可能。
- データベースとの照合を行わないため、処理が簡潔。

### 【1対多モード】
一方、「1対多」モードは、1つの顔画像をデータベースと照合し、最も一致する人物を特定する方法です。このモードは、監視カメラシステムや公共施設のアクセス制御など、大量の顔データを管理するシステムで一般的に使用されます。

特徴:
- データベース全体と照合するため、計算コストが高い。
- 顔IDの分類タスクとして設計される。
- 複数の人物から候補を絞り込むことが可能。

---

## Siamese Networkとは？

### 概要
Siamese Networkは1993年にBromleyらによって提案され、当初は手書き文字認証に使用されていました。このネットワークは、2つの入力を受け取り、それらの類似度を学習する構造を持っています。現在では以下のような分野で広く活用されています：
- 顔認証
- 画像類似度検索
- 生体認証
- 画像位置合わせ

### 主な特徴
Siamese Networkは、同一構造の2つのサブネットワークで特徴を抽出し、その類似性を計算します。この構造により、「1対1」タスクに特化した高い性能を発揮します。

- 特徴抽出器として共有されたバックボーンを使用。
- Contrastive LossやTriplet Lossを用いてペア単位での学習を行う。
- 少ないデータセットでも効果的に学習可能。

---

## Siamese Networkが【1対1】学習に適している理由

Siamese Networkが「1対1」モードに適している主な理由は以下の通りです：

1. **類似度を直接学習する特性**:
   - 特徴ベクトル間の距離を計算することで、同一人物の距離を最小化し、異なる人物の距離を最大化します。

2. **少ないデータや限定的なタスクへの適応力**:
   - データ量が限定されている場合でも、ペア単位での学習が可能なため、少ない画像から高い認識性能を引き出します。

3. **汎用性の高さ**:
   - 顔認証以外の生体認証や類似度判定タスクにも応用可能です。

---

## 【1対1モード】における他のネットワーク選択肢

「1対1」タスクにはSiamese Network以外にもいくつかの選択肢があります。それぞれの特徴と利点を見てみましょう。

### ArcFace
ArcFaceは、ResNetやEfficientNetをバックボーンに用いる高精度な顔認識モデルです。このネットワークは埋め込み空間での顔IDの分類タスクに特化しており、特に「1対多」モードでその性能を発揮しますが、「1対1」モードにも適応可能です。

### Triplet Network
Triplet Networkは、Siamese Networkに似た構造を持ちますが、アンカー、ポジティブ、ネガティブの3つの入力を使用します。これにより、埋め込み空間の識別性を高めることができます。「1対1」タスクに特化したモデル設計が可能です。

### FaceNet
Googleが開発したFaceNetは、埋め込みベースの顔認識モデルで、計算効率と精度を両立しています。Siamese Networkと同様に、「1対1」タスクに優れたパフォーマンスを発揮します。

---

## Siamese Networkにおけるバックボーン

Siamese Networkの性能は、バックボーンの選択によって大きく左右されます。

### 概要
EfficientNetV2やResNetなど、高性能なバックボーンを利用することで、入力画像から有用な特徴を効率的に抽出できます。

### バックボーンの役割
バックボーンは、ネットワークの基盤として機能し、入力データを低次元の特徴ベクトルに変換します。この特徴ベクトルが、類似度計算や分類タスクの基盤となります。

### ネットワーク全体の役割
Siamese Networkでは、バックボーンで抽出された特徴ベクトルを比較し、入力ペアの類似性を判定します。これにより、同一人物か否かの判断が可能になります。

---

## Siamese Networkに最適な損失関数

Siamese Networkでは、以下のような損失関数を使用して類似度を学習します。

### Contrastive Loss
Contrastive Lossは、2つの入力間の距離を学習するために使用されます。同一人物の場合は距離を最小化し、異なる人物の場合は距離を最大化します。

### Triplet Loss
Triplet Lossは、アンカー、ポジティブ、ネガティブの3つの入力を用いて類似性を最適化します。この損失関数は、埋め込み空間での識別性を向上させる効果があります。

### Binary Cross-Entropy Loss
Binary Cross-Entropy Lossは、2つの入力が同一か否かを確率的に予測する損失関数です。主に類似度を確率として出力したい場合に使用されます。

---

## Siamese Networkで必要なID数の見積もり

### ID数よりペア数が重要
Siamese Networkでは、IDの数そのものよりも生成可能なペアの数が重要です。
- **同一ID内（Positiveペア）**: 同一人物間でのペア。
- **異なるID間（Negativeペア）**: 異なる人物間でのペア。

### 推奨されるID数の目安
- **小規模タスク**: 数百ID。
- **中規模タスク**: 1000～2000ID。
- **大規模タスク**: 5000ID以上。

### その他の重要点
ペアの多様性や各IDに含まれる画像数がモデルの性能に影響を与えるため、データの質が重要です。

---

## オプティマイザの選択

Siamese Networkの学習には以下のオプティマイザが使用されます：

### Adam
- 安定した収束と効率的な学習が可能。

### AdamW
- 正則化付きで過学習を防ぐ効果がある。

### SGD + モメンタム
- 大規模データセットや学習の微調整に適している。

### Ranger
- 勾配変動が激しい場合や収束が不安定な場合に有効。

---

## Siamese Networkやトリプレットロスを用いて学習する際の便利なライブラリ

### PyTorch Metric Learning
PyTorch Metric Learningは、Siamese Networkやトリプレットロスを用いた学習を簡単にするためのライブラリです。

**特徴:**
- Contrastive LossやTriplet Lossをサポート。
- ハードネガティブマイニング機能が付属。

**利点:**
- モジュールが豊富でカスタマイズが容易。
- ドキュメントが充実しており初心者にも扱いやすい。

---

## Siamese Networkの実装例

以下はSiamese NetworkをEfficientNetV2をバックボーンとして構築し、Triplet Lossを使用した学習コードの例です。

```python
import torch
import torch.nn as nn
import torch.optim as optim
from torchvision.models import efficientnet_v2_s

# Siamese Networkの定義
class SiameseNetwork(nn.Module):
    def __init__(self, backbone):
        super(SiameseNetwork, self).__init__()
        self.backbone = backbone
        self.fc = nn.Linear(1000, 128)  # 埋め込み次元を128に調整

    def forward(self, x1, x2):
        embed1 = self.fc(self.backbone(x1))
        embed2 = self.fc(self.backbone(x2))
        return embed1, embed2

